# Логика подсчета батчей и пропущенных TVC

## Текущая логика (ПРОБЛЕМНАЯ)

### Шаг 1: Сбор голосов
```go
votes := voteAccountData.Votes  // Все голоса из vote account
sort.Slice(votes, ...)          // Сортируем по слотам
```

### Шаг 2: Определение границ батча
```go
batchNum = (slot / 20000) + 1
batchStartSlot = (batchNum - 1) * 20000
batchEndSlot = batchNum * 20000 - 1
```

**Пример для батча 19074:**
- `batchStartSlot = 381460000`
- `batchEndSlot = 381479999`
- Если текущий слот = 381475335, то `batchEndSlot` обрезается до `381475335`

### Шаг 3: Фильтрация голосов в батч
```go
for vote in votes {
    if vote.Slot >= batchStartSlot && vote.Slot <= batchEndSlot {
        batchVotes.append(vote)
    }
}
```

### Шаг 4: Подсчет проголосованных слотов
```go
votedSlotMap = {}
for vote in batchVotes {
    votedSlotMap[vote.Slot] = true  // Уникальные слоты
}
VotedSlots = len(votedSlotMap)
```

### Шаг 5: Подсчет пропущенных слотов
```go
TotalSlots = batchEndSlot - batchStartSlot + 1  // 15336 для live батча
MissedSlots = TotalSlots - VotedSlots            // 15336 - 30 = 15306
MissedTVCs = MissedSlots                         // 15306
```

## ПРОБЛЕМА

**Мы считаем, что валидатор должен голосовать за КАЖДЫЙ слот в батче, но это НЕПРАВИЛЬНО!**

В Solana:
- Валидатор голосует только за блоки, которые он подтверждает
- Валидатор НЕ голосует за каждый слот в сети
- TVC начисляются только за реальные голоса

**Правильная логика должна быть:**
- Считать пропущенные TVC только для слотов, где валидатор МОГ проголосовать
- Но как определить, где валидатор мог проголосовать?

## ВОЗМОЖНЫЕ ПРОБЛЕМЫ

1. **Голоса не попадают в батч** - возможно, голоса находятся вне диапазона батча
2. **Неправильный подсчет** - мы считаем все слоты как "должен был проголосовать"
3. **Голоса не загружаются** - возможно, не все голоса загружаются из RPC

## НУЖНО ПРОВЕРИТЬ

1. Сколько всего голосов в `voteAccountData.Votes`?
2. Сколько голосов попадает в батч 19074?
3. Какие слоты у этих голосов?
4. Правильно ли определяются границы батча?
